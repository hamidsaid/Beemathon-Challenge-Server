var httpRequest;
var beemPage;
function removeAnimated(elem, price) {
  elem.target.removeAttribute("disabled");
  elem.target.innerHTML = 'Pay ' + price;
  elem.target.className = "beem-action";
  elem.target.addEventListener("click", clickEvent)
};

function closeButton(page) {
  page.firstElementChild
    .querySelector('button')
    .addEventListener('click', (e) => {
      if(e.path) {
        var k = e.path[2];
        k.removeChild(e.path[2].children[1]);
        page.removeChild(page.firstElementChild);
      } else if(e.target) {
        page.removeChild(e.target.parentElement.offsetParent.children[1]);
        page.removeChild(e.target.parentElement.offsetParent.children[0]);
      }
    
    });
};

function APICall(price, mobile, reference,transaction, elem) {
  beemPage = document.querySelector('#beem-page');
  if (window.XMLHttpRequest) {
    httpRequest = new XMLHttpRequest();
  } else if (window.ActiveXObject) {
    httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
  }

  httpRequest.onreadystatechange = function () {
    if (httpRequest.readyState === XMLHttpRequest.DONE) {
      if (httpRequest.status === 200) {
        const res = JSON.parse(httpRequest.responseText);
        localStorage.setItem('key', res.token);
        removeAnimated(elem, price);
        beemPage.innerHTML = '<div class="beem-page__close"><button>&times; &nbsp;Close</button></div><iframe src="' + res.src + '"></iframe>';
        closeButton(beemPage);
      } else {
        const err = JSON.parse(httpRequest.responseText);
        removeAnimated(elem, price);
        beemPage.innerHTML = '<div class="beem-page__close"><button>&times; &nbsp;Close</button></div>' + "<iframe src='" + err.src + "' style='height: 200px!important'></iframe>";
        closeButton(beemPage);
      }
    }
  };

  var url = "https://checkout.beem.africa/get-iframe?price=" + price;
  if (mobile) url = url + '&mobile=' + mobile;
  if (reference) url = url + '&reference_number=' + reference;
  if (transaction) url = url + '&transaction_id=' + transaction;
  httpRequest.open('GET', url);
  httpRequest.withCredentials = true;
  httpRequest.send();
};

function clickEvent(e) {
  var price = e.target.dataset.price;
  var mobile = e.target.dataset.mobile;
  var reference = e.target.dataset.reference;
  var transaction = e.target.dataset.transaction;
  e.target.innerHTML = "<span class='lds-dual-ring'></span> Pay" + price;
  e.target.setAttribute("disabled", true);
  e.target.className += " disabled";
  APICall(price, mobile, reference, transaction, e);
};

function InitializeBeem() {
  var btns = document.querySelectorAll("#beem-button");
  btns.forEach(function (elem) {
    var price = elem.dataset.price;
    var mobile = elem.dataset.mobile;
    var reference = elem.dataset.reference;
    var transaction = elem.dataset.transaction;

    if(!isNaN(price) && reference && transaction){
      if(mobile){
        elem.innerHTML = "<button id='beem-action' class='beem-action' data-price='" + price + "' data-transaction='" + transaction + "'  data-mobile='" + mobile + "' data-reference='" + reference + "'>Pay " + price + "</button>";
      }else{
        elem.innerHTML = "<button id='beem-action' class='beem-action' data-price='" + price + "' data-transaction='" + transaction + "'  data-reference='" + reference + "'>Pay " + price + "</button>";
      }
    }

    var actionBtn = elem.querySelector("#beem-action")
    actionBtn.addEventListener("click", clickEvent);
  });
};

module.exports = InitializeBeem;
